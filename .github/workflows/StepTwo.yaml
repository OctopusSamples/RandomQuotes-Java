name: Step-Two
      
#on:  
#  workflow_run:
#    workflows: [Step-One]
#    branches: [master]
#    types: [completed]
on:
  push:
    branches:
    - master

#on: 
#  pull_request:
#    branches: [master]

#    types:
#      - closed

env:  
  PACKAGES_FOLDER: Modules
  OUTPUT_FOLDER: PackagesOutput
  PACKAGE_NAME: TestingPullRequestBI
  OCTOPUS_PROJECT_NAME: RandomQuotes  
  OCTOPUS_SPACE_NAME: JeremyM
  ENVIRONMENT: Development
  CHANNEL: Default
  OCTOPUS_API_KEY: ${{ secrets.OCTOPUS_API_KEY }}   # API key used with Octopus Deploy instance
  OCTOPUS_HOST: ${{ secrets.OCTOPUS_URL }}       # address of Octopus Deploy instance (i.e. https://demo.octopus.app)   
  OCTOPUS_URL: ${{ secrets.OCTOPUS_URL }}       # address of Octopus Deploy instance (i.e. https://demo.octopus.app)   
  OCTOPUS_SPACE: 'JeremyM'

jobs:
  build:
    name: Build and Push Website
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3  
    - name: Set environment variables
      run: |
        $branchName = ((${env:GITHUB_REF} -replace "refs/heads/", "") -replace "feature/", "") -replace "bugfix/", ""
        Write-Host "Branch name: $branchName"  
        $defaultVersionPrefix = "1.0"
        $versionNumber = "$defaultVersionPrefix.${{ github.RUN_NUMBER }}"
        $channelName = "Default"
        $deployEnvironment = "Development"
        $commitMessage = git log -1 --pretty=oneline
        Write-Host "The commit message is: $commitMessage"
        if ($branchName -ne "master")
        {
           $versionNumber = "0.0.${{ github.RUN_NUMBER }}"
           $channelName = "Feature Branches"
           $deployEnvironment = "Test"           
        }
        Write-Host "Setting environment variable PACKAGE_VERSION to: $versionNumber"
        Write-Host "Setting environment variable BRANCH_NAME to: $branchName"
        Write-Host "Setting environment variable CHANNEL_NAME to: $channelName"
        Write-Host "Setting environment variable ENVIRONMENT_NAME to: $deployEnvironment"
        echo "BRANCH_NAME=$branchName" | Out-File -FilePath $env:GITHUB_ENV  -Append
        echo "PACKAGE_VERSION=$versionNumber" | Out-File -FilePath $env:GITHUB_ENV  -Append
        echo "CHANNEL_NAME=$channelName" | Out-File -FilePath $env:GITHUB_ENV  -Append
        echo "ENVIRONMENT_NAME=$deployEnvironment" | Out-File -FilePath $env:GITHUB_ENV  -Append
      shell: pwsh
      
    - name: Push Build Information to Octopus Deploy
        # You may pin to the exact commit or the version.
        # uses: OctopusDeploy/push-build-information-action@5096721de3c3074bb3906ee25eff7339ad4cdde3
      uses: OctopusDeploy/push-build-information-action@v3.0.3
      with:
          # A multi-line list of packages to push to Octopus Deploy.
        packages: ${{ env.PACKAGE_NAME }}
          # The version of the package(s)
        version: ${{ env.PACKAGE_VERSION }}      
    


    - name: "ü§© GitHub Environment Variables Action"
      uses: FranzDiebold/github-env-vars-action@v2
    - name: "üêô Install Octopus CLI"
      uses: OctopusDeploy/install-octopus-cli-action@v1.2.0
      with:
        version: latest
    - name: "üìù Create Build Info File"
      run: |
        $Commits = [PSCustomObject]@{
            Id = $ENV:GITHUB_SHA;
            Comment = (git log --format=%B --no-merges -n 1) | Select -First 1;
        }
        $BuildInfo = @{
            BuildEnvironment = "GitHub Action";
            Branch = $ENV:CI_ACTION_REF_NAME;
            BuildNumber = $ENV:GITHUB_RUN_NUMBER;
            BuildUrl = "$ENV:GITHUB_SERVER_URL/$ENV:GITHUB_REPOSITORY/actions/runs/$ENV:GITHUB_RUN_ID";
            VcsType = "Git";
            VcsRoot = "$ENV:GITHUB_SERVER_URL/$ENV:GITHUB_REPOSITORY";
            VcsCommitNumber = $ENV:GITHUB_SHA;
            Commits = @($Commits)
        }
        $BuildInfo
        New-Item -Name "buildInfo.json" -ItemType File -Value $($BuildInfo | ConvertTo-Json -Depth 10) -Force
        octo build-information --package-id="${{ env.PACKAGE_NAME }}2" --version=${{ env.PACKAGE_VERSION }} --file="buildInfo.json" --server $ENV:OCTOPUS_URL --apiKey $ENV:OCTOPUS_API_KEY --overwrite-mode=OverwriteExisting
      shell: pwsh
        



